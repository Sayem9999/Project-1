# Deployment Guide for ProEdit AI

This guide covers how to deploy the ProEdit AI application to Render.com, configure Cloudflare R2 for storage, and set up Sentry for observability.

## Prerequisites

- **GitHub Repository**: Connected to your Render account.
- **Render Account**: For hosting the backend (Web Service) and worker (Background Worker).
- **Cloudflare R2**: For object storage (videos, outputs).
- **Sentry Account**: For error tracking.
- **Redis**: For the Celery task queue (Render Redis or external provider).

## 1. Environment Variables

The `render.yaml` file defines the infrastructure as code, but sensitive secrets must be set manually in the Render Dashboard.

| Variable | Description | Required? |
| :--- | :--- | :--- |
| `DATABASE_URL` | PostgreSQL connection string (Auto-set by Render if using Blueprint) | Yes |
| `REDIS_URL` | Redis connection string (Auto-set or manual) | Yes |
| `SECRET_KEY` | Flask/FastAPI secret key (Auto-generated by Blueprint) | Yes |
| `GEMINI_API_KEY` | Google Gemini API Key for AI processing | Yes |
| `STRIPE_SECRET_KEY` | Stripe Secret Key for payments | Yes |
| `STRIPE_WEBHOOK_SECRET` | Stripe Webhook Secret for event verification | Yes |
| `FRONTEND_URL` | URL of the frontend (e.g., Vercel) for CORS and redirects | Yes |
| `ADMIN_BOOTSTRAP_EMAIL` | One-time admin bootstrap email (optional) | No |
| `ADMIN_BOOTSTRAP_ONCE` | If true, only bootstraps when user is not already admin | No |
| `SENTRY_DSN` | Sentry Data Source Name for error reporting | No (Recommended) |

### Cloudflare R2 Credentials
| Variable | Description |
| :--- | :--- |
| `R2_ACCOUNT_ID` | Cloudflare Account ID |
| `R2_ACCESS_KEY_ID` | R2 Access Key ID |
| `R2_SECRET_ACCESS_KEY` | R2 Secret Access Key |
| `R2_BUCKET_NAME` | Name of the R2 bucket |
| `R2_PUBLIC_URL` | Public domain for the bucket (optional) |

## 2. Deployment Steps

### Method A: Render Blueprint (Recommended)

1.  **Push Changes**: Ensure `render.yaml` is in the root of your repository.
2.  **New Blueprint**: In Render Dashboard, go to "Blueprints" > "New Blueprint Instance".
3.  **Connect Repo**: Select your `Project-1` repository.
4.  **Auto-Discovery**: Render will read `render.yaml` and propose creating:
    - `proedit-api` (Web Service)
    - `proedit-db` (Postgres)
    - *Note: The background worker is now embedded in the Web Service to save costs on the Free Tier.*
5.  **Apply**: Click "Apply".
6.  **Configure Environment**:
    - Go to the `proedit-api` service's "Environment" tab.
    - Add the **Missing** variables listed above (especially R2 and Stripe keys) that show as `sync: false` in the YAML.

### Method B: Manual Deployment

If not using Blueprints, create services manually:

1.  **Web Service**:
    - Build Command: `cd backend && ./render-build.sh`
    - Start Command: `cd backend && ./start.sh`
    - *Note: `start.sh` now starts both the API and the Background Worker under one service.*

### Method C: Frontend Deployment (Vercel) [Recommended]

Since this is a Next.js app, Vercel is the easiest deployment option.

1.  **Push Changes**: Ensure your code is on GitHub.
2.  **Import Project**: Go to [Vercel Dashboard](https://vercel.com/new) and import your repository.
3.  **Configure Project**:
    - **Framework Preset**: Next.js (Auto-detected).
    - **Root Directory**: `frontend` (Click "Edit" next to Root Directory and select the `frontend` folder).
4.  **Environment Variables**:
    - `NEXT_PUBLIC_API_BASE`: The URL of your Render Backend (e.g., `https://proedit-api.onrender.com/api`).
    - `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`: Your Stripe Public Key.
    - `NEXT_PUBLIC_SENTRY_DSN`: Your Sentry DSN (if using Sentry).
5.  **Deploy**: Click "Deploy".

## 3. Verifying Deployment

1.  **Health Check**: Visit `https://<YOUR-APP-URL>.onrender.com/health` -> Should return `{"status": "ok"}`.
2.  **Admin Stats**: Visit `https://<YOUR-APP-URL>.onrender.com/api/admin/stats` (requires auth token).
3.  **Frontend Connection**: Ensure your frontend `NEXT_PUBLIC_API_BASE` points to this new Render URL.

## 4. Troubleshooting

- **Build Fails?**: Check if `render-build.sh` is executable. The YAML includes `chmod +x`, but you can also run `git update-index --chmod=+x backend/render-build.sh`.
- **Database Errors?**: The app runs `alembic upgrade head` on startup. check logs for "startup_migrations_failed".
- **Tasks Not Running?**: Check `proedit-worker` logs. Ensure `REDIS_URL` is correct.
